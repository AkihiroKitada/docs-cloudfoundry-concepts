---
title: High Availability
owner:
---

<strong><%= modified_date %></strong>

A platform as a service (PaaS) is not only about providing middleware that your application can leverage, it is about doing more on behalf of the developer and operator. A modern PaaS must keep apps up and running in the face of failures within the system. From the onset, the Pivotal CF enterprise PaaS has been built to make both the developer and operator’s jobs easier, and in this post I’ll tell you a bit about how it’s done.

## <a id='azs'></a>Availability Zones ##

Cloud Foundry supports deploying applications instances across multiple availability zones (AZs). This level of high availability requires that you sensibly define AZs in your IaaS. For example, in vSphere you define one AZ for one vCenter resource pool, and another AZ for a second resource pool. You can configure your deployment so that Diego cells are created across these AZs by [configuring high level instructions here]. With this configuration in place, Cloud Foundry balances the applications you deploy across the AZs you defined. If an AZ goes down, you still have application instances running in another. 

## <a id='health-management-apps'></a>Health Management for App Instances ##

1. The nsync, Converger, and Cell Rep components monitor application instances.
2. If these components detect a discrepancy, they advise the cloud controller. 
3. The cloud controller initiates a new deployment of the app. 

If you lose application instances for any reason, if there is a bug in the app, or if an AZ goes down, Pivotal CF will restart new instances so that capacity is maintained. The elastic runtime health manager constantly tracks the state of the system. In particular, the number of instances of each application that are running across all of the DEAs (Diego Cells?). When the elastic runtime health manager detects a discrepancy between the actual state of the app instances in the cloud and the desired state, as known by the cloud controller, it advises the cloud controller of the difference and the cloud controller will initiate the deployment of new application instances.

## <a id='monitored-processes'></a>Monitored processes ##

Cloud Foundry uses a BOSH agent and monit to monitor the processes on the component VMs that work together to keep your applications running, such as nsync, Converger, and Cell Rep. If monit detects a failure, it restarts the process and notifies the BOSH agent on the VM. The BOSH agent also notifies the BOSH Health Monitor, which triggers responders through plugins such as email notifications or paging.

## <a id='health-management-vms'></a>Health Management for Virtual Machines ##

(You have to enable the resurrector)

1. Bosh agent on a vm could disappear.
1. Bosh agent sends out "heartbeat" messages every minute. 
1. OM Health Monitor listens for these heartbeats. 
1. If hearbeat is missing, Health Monitor alerts list of responders, including the ressurector
1. Ressurector asks for the failed vm to be replaced. 

The BOSH agent on a VM can only communicate back to the Ops Manager if the VM is there.  WHen a VM disappears, by which we mean that the BOSH agent is not functional, the VM could exist, but Ops Manager no longer knows the VM status. 

Ops Manager detects if a VM is present by listening for heartbeat messages that are sent from the BOSH agent every 60 seconds. The OMHM constantly listens for those heartbeats, and when it finds that one is missing, it produces an alert and passes that through the list of responders. 

As described previously, emails, pages, and operations dashboard alerts could result from a VM failure. There is also one more responder that kicks in, which is the resurrector. The resurrector communicates with the IaaS over which Pivotal CF is running, and requests that the failed VM be replaced with a VM running the appropriate part of the Elastic Runtime–i.e., a health manager or DEA (Diego Cell?),. Ops Manager restarts failed cluster components.































