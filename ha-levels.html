---
title: High Availability
owner:
---

<strong><%= modified_date %></strong>

A platform as a service (PaaS) is not only about providing middleware that your application can leverage, it is about doing more on behalf of the developer and operator. A modern PaaS must keep apps up and running in the face of failures within the system. From the onset, the Pivotal CF enterprise PaaS has been built to make both the developer and operator’s jobs easier, and in this post I’ll tell you a bit about how it’s done.

## <a id='azs'></a>Availability Zones ##

Cloud Foundry supports deploying applications instances across multiple availability zones (AZs). This level of high availability requires that you sensibly define AZs in your IaaS. For example, in vSphere you define one AZ for one vCenter resource pool, and another AZ for a second resource pool. You can configure your deployment so that Diego cells are created across these AZs by [configuring high level instructions here]. With this configuration in place, Cloud Foundry balances the applications you deploy across the AZs you defined. If an AZ goes down, you still have application instances running in another. 

## <a id='health-management-apps'></a>Health Management for App Instances ##

1. The nsync, Converger, and Cell Rep components monitor application instances.
2. If it these compenents detect a discrepancy, they advise the cloud controller. 
3. The cloud controller intiates a new deployment of the app. 

Of course, if you lose application instances for any reason, a bug in the app, an AZ goes down, etc. you’ll want the system to compensate, restarting new instances so that we keep the capacity we are aiming for. This is where the elastic runtime health manager comes in. The health manager is constantly keeping tabs on the state of the system, in particular, how many instances of each application are running across all of the DEAs. When it detects a discrepancy between the actual state of the app instances in the cloud and the desired state, as known by the cloud controller, it advises the cloud controller of the difference and the cloud controller will initiate the deployment of new application instances. That’s another level.

## <a id='monitored-processes'></a>Monitored processes ##

Cloud Foundry uses a BOSH agent and monit to monitor the processes on the component VMs that work together to keep your applications running, such as nsync, Converger, and Cell Rep. If monit detects a failure, it restarts the process and notifies the BOSH agent on the VM. The BOSH agent also notifies the BOSH Health Monitor, which triggers responders through plugins such as email notifications or paging.

## <a id='health-management-vms'></a>Health Management for Virtual Machines ##

(You have to enable the resurrector)

1. Bosh agent on a vm could disappear.
1. Bosh agent sends out "heartbeat" messages every minute. 
1. OM Health Monitor listens for these heartbeats. 
1. If hearbeat is missing, Health Monitor alerts list of responders, including the ressurector
1. Ressurector asks for the failed vm to be replaced. 

Of course, the BOSH agent on a VM can only communicate back to the Ops Manager if the VM is there, so let’s talk about what happens when a VM disappears. By “disappear” I mean that the BOSH agent is not functional; the VM could be there, but Ops Manager no longer knows what it is up to so for all intents and purposes it’s “gone”.  How does Ops Manager know? One of the things that a BOSH agent is responsible for is sending out heartbeat messages and by default it does so every 60 seconds. The OMHM is constantly listening for those heartbeats and when it finds that one is missing it will itself produce an alert and pass that through the list of responders. Just as described above, this could result in emails, pages and operations dashboard alerts, but in this case there is one more responder that kicks in – the “resurrector”. The resurrector will communicate with the IaaS over which Pivotal CF is running and will ask that the failed VM be replaced. Of course it will be replaced with a VM running the appropriate part of the Elastic Runtime–i.e., a health manager or DEA, etc. That’s right, Ops Manager will restart failed cluster components. That is the fourth level.































